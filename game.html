<script>
document.addEventListener("DOMContentLoaded", async () => {
  const slug = new URLSearchParams(window.location.search).get("slug");
  const statusEl = document.getElementById("status");
  const contentEl = document.getElementById("content");

  if (!slug) {
    if (statusEl) statusEl.textContent = "Missing slug in URL.";
    return;
  }

  try {
    const res = await fetch(`/api/game?slug=${encodeURIComponent(slug)}`, { cache: "no-store" });
    const data = await res.json();

    if (!res.ok || !data) {
      if (statusEl) statusEl.textContent = "Error loading game.";
      return;
    }

    const name = data.name || "Untitled";
    const released = data.released || "TBA";
    const website = data.website || "";
    const description =
      data.description_raw || data.description || "No description available.";
    const img = data.background_image || "";

    const trailer =
      (data.clip && (data.clip.clip || data.clip.video)) ||
      (Array.isArray(data.movies) && data.movies[0]?.data?.max) ||
      null;

    const screenshots =
      Array.isArray(data.screenshots) && data.screenshots.length
        ? data.screenshots
        : Array.isArray(data.short_screenshots)
        ? data.short_screenshots
        : [];

    const stores = Array.isArray(data.stores) ? data.stores : [];
    const storeLinks = stores
      .map(
        (s) =>
          `<a href="${s.url}" target="_blank" class="store-btn">Buy on ${
            s.store?.name || "Store"
          }</a>`
      )
      .join("");

    const platforms = (data.platforms || []).map((p) => p.platform?.name).filter(Boolean);
    const genres = (data.genres || []).map((g) => g.name).filter(Boolean);
    const badges = [...platforms, ...genres]
      .slice(0, 12)
      .map((x) => `<span class="badge">${x}</span>`)
      .join("");

    let metacritic = data.metacritic ?? null;
    if (!metacritic && Array.isArray(data.metacritic_platforms)) {
      const scores = data.metacritic_platforms
        .map((p) => p.metascore)
        .filter((s) => typeof s === "number");
      if (scores.length)
        metacritic = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
    }
    const metaColor =
      metacritic >= 75 ? "#16a34a" : metacritic >= 50 ? "#facc15" : "#dc2626";

    const hero = `
      <div class="hero-banner" style="background-image:url('${img}')">
        <div class="overlay-gradient"></div>
        <div class="hero-content">
          <h1>${name}</h1>
          <div class="meta">Released: ${released}</div>
          <div class="score" style="background:${metaColor}">
            ${metacritic ? `Metacritic: ${metacritic}` : "No Score"}
          </div>
          <div class="badges">${badges}</div>
          <div class="links">
            ${website ? `<a href="${website}" target="_blank" class="store-btn">Official Site</a>` : ""}
            ${storeLinks}
          </div>
        </div>
      </div>`;

    const trailerBlock = trailer
      ? `
        <div class="trailer-container">
          <video id="gameTrailer" autoplay muted loop playsinline poster="${img}">
            <source src="${trailer}" type="video/mp4" />
          </video>
          <button id="soundToggle" class="sound-btn">ðŸ”‡</button>
        </div>`
      : "";

    const screenshotBlock = screenshots.length
      ? `
        <div class="screenshot-carousel">
          ${screenshots
            .map(
              (s) =>
                `<img src="${s.image}" alt="Screenshot" class="screenshot-thumb" loading="lazy">`
            )
            .join("")}
        </div>`
      : `<div class="panel" style="text-align:center;color:#777;">No screenshots available.</div>`;

    const about = `
      <div class="panel">
        <h2>About</h2>
        <p>${description}</p>
      </div>`;

    if (contentEl) {
      contentEl.innerHTML = hero + trailerBlock + screenshotBlock + about;
      if (statusEl) statusEl.remove();
      contentEl.style.display = "block";
    }

    const video = document.getElementById("gameTrailer");
    const btn = document.getElementById("soundToggle");
    if (video && btn) {
      btn.addEventListener("click", () => {
        video.muted = !video.muted;
        btn.textContent = video.muted ? "ðŸ”‡" : "ðŸ”Š";
      });
    }

    const row = document.querySelector(".screenshot-carousel");
    if (row) {
      let speed = 0.6;
      function scrollLoop() {
        row.scrollLeft =
          (row.scrollLeft + speed) % (row.scrollWidth - row.clientWidth + 1);
        requestAnimationFrame(scrollLoop);
      }
      scrollLoop();
    }
  } catch (err) {
    console.error("loadGame error:", err);
    if (statusEl) statusEl.textContent = "Error loading game data.";
  }
});
</script>
