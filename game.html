<script>
async function loadGame() {
  const slug = new URLSearchParams(window.location.search).get("slug");
  const statusEl = document.getElementById("status");
  const contentEl = document.getElementById("content");

  if (!slug) {
    statusEl.textContent = "Missing slug in URL.";
    return;
  }

  try {
    // âœ… Force English language
    const res = await fetch(`/api/game?slug=${encodeURIComponent(slug)}&languages=en`, { cache: "no-store" });
    const data = await res.json();

    if (!res.ok || !data) {
      statusEl.textContent = "Error loading game data.";
      console.error("Invalid response:", data);
      return;
    }

    // --- Core fields ---
    const name = data.name || "Untitled";
    const released = data.released || "TBA";
    const website = data.website || "";
    const description = (data.description_raw || data.description || "No description available.").replace(/<[^>]+>/g, "");
    const img = data.background_image || "";

    // --- Trailer detection (covers all RAWG formats) ---
    let trailer = null;
    if (data.clip?.clip) trailer = data.clip.clip;
    else if (Array.isArray(data.movies) && data.movies.length) {
      trailer = data.movies[0]?.data?.max || data.movies[0]?.data?.["480"] || data.movies[0]?.preview || null;
    }

    // --- Screenshots fallback-safe ---
    let screenshots = [];
    try {
      if (Array.isArray(data.screenshots) && data.screenshots.length) {
        screenshots = data.screenshots;
      } else if (Array.isArray(data.short_screenshots) && data.short_screenshots.length) {
        screenshots = data.short_screenshots;
      }
    } catch (e) {
      console.warn("screenshot parse fail:", e);
    }

    // --- Stores ---
    const stores = Array.isArray(data.stores) ? data.stores : [];
    const storeLinks = stores.map(
      (s) => `<a href="${s.url}" target="_blank" class="store-btn">Buy on ${s.store?.name || "Store"}</a>`
    ).join("");

    // --- Platforms & genres ---
    const platforms = (data.platforms || []).map(p => p.platform?.name).filter(Boolean);
    const genres = (data.genres || []).map(g => g.name).filter(Boolean);
    const badges = [...platforms, ...genres].slice(0, 12).map(x => `<span class="badge">${x}</span>`).join("");

    // --- Metacritic ---
    let metacritic = data.metacritic ?? null;
    if (!metacritic && Array.isArray(data.metacritic_platforms)) {
      const scores = data.metacritic_platforms.map(p => p.metascore).filter(s => typeof s === "number");
      if (scores.length) metacritic = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
    }
    const metaColor = metacritic >= 75 ? "#16a34a" : metacritic >= 50 ? "#facc15" : "#dc2626";

    // --- Hero section ---
    const hero = `
      <div class="hero-banner" style="background-image:url('${img}')">
        <div class="overlay-gradient"></div>
        <div class="hero-content">
          <h1>${name}</h1>
          <div class="meta">Released: ${released}</div>
          <div class="score" style="background:${metaColor}">
            ${metacritic ? `Metacritic: ${metacritic}` : "No Score"}
          </div>
          <div class="badges">${badges}</div>
          <div class="links">
            ${website ? `<a href="${website}" target="_blank" class="store-btn">Official Site</a>` : ""}
            ${storeLinks}
          </div>
        </div>
      </div>`;

    // --- Trailer ---
    const trailerBlock = trailer
      ? `
        <div class="trailer-container">
          <video id="gameTrailer" autoplay muted loop playsinline poster="${img}">
            <source src="${trailer}" type="video/mp4" />
          </video>
          <button id="soundToggle" class="sound-btn">ðŸ”‡</button>
        </div>`
      : "";

    // --- Screenshots carousel ---
    const screenshotBlock = screenshots.length
      ? `
        <div class="screenshot-row">
          ${screenshots
            .map(
              (s) =>
                `<img src="${s.image}" alt="Screenshot" loading="lazy" class="screenshot-thumb" />`
            )
            .join("")}
        </div>`
      : "";

    // --- About ---
    const about = `
      <div class="panel">
        <h2>About</h2>
        <p>${description}</p>
      </div>`;

    // --- Render everything ---
    contentEl.innerHTML = hero + trailerBlock + screenshotBlock + about;
    statusEl.remove();
    contentEl.style.display = "block";

    // --- Sound toggle ---
    const video = document.getElementById("gameTrailer");
    const btn = document.getElementById("soundToggle");
    if (video && btn) {
      btn.addEventListener("click", () => {
        video.muted = !video.muted;
        btn.textContent = video.muted ? "ðŸ”‡" : "ðŸ”Š";
      });
    }

    // --- Netflix-style auto-scroll ---
    const row = document.querySelector(".screenshot-row");
    if (row) {
      let scrollSpeed = 1.4;
      function scrollLoop() {
        row.scrollLeft = (row.scrollLeft + scrollSpeed) % (row.scrollWidth - row.clientWidth + 1);
        requestAnimationFrame(scrollLoop);
      }
      scrollLoop();
    }

  } catch (err) {
    console.error("loadGame error:", err);
    statusEl.textContent = "Error loading game data.";
  }
}

loadGame();
</script>
