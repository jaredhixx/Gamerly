<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gamerly â€“ Game Details</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <div style="max-width: 900px; margin: 0 auto;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <a href="/" style="color: white; text-decoration: none; font-weight: 900;">Gamerly ðŸ”¥</a>
          <span style="opacity: 0.6;">/</span>
          <a href="/" style="color: white; opacity: 0.9; text-decoration: none;">â¬… Back to New Releases</a>
        </div>
      </div>
    </header>

    <main>
      <div id="status" class="panel">Loadingâ€¦</div>
      <div id="content" style="display: none;"></div>
    </main>

    <script>
      async function loadGame() {
        const slug = new URLSearchParams(window.location.search).get("slug");
        const statusEl = document.getElementById("status");
        const contentEl = document.getElementById("content");

        if (!slug) {
          statusEl.textContent = "Missing slug in URL.";
          return;
        }

        try {
          const res = await fetch(`/api/game?slug=${encodeURIComponent(slug)}`, { cache: "no-store" });
          const data = await res.json();
          if (!res.ok || !data || data.error) {
            statusEl.textContent = "Error loading game data.";
            console.error(data);
            return;
          }

          const name = data.name || "Untitled";
          const released = data.released || "TBA";
          const img = data.background_image || "";
          const website = data.website || "";
          const description = data.description_raw || "No description available.";
          const clip = data.clip?.clip || null;

          // âœ… Pull safe screenshots
          const screenshots = Array.isArray(data.short_screenshots) ? data.short_screenshots : [];

          // ðŸŽ¬ Trailer
          const trailer = clip
            ? `
              <div class="trailer-container">
                <video id="gameTrailer" autoplay muted loop playsinline poster="${img}">
                  <source src="${clip}" type="video/mp4" />
                </video>
                <button id="soundToggle" class="sound-btn">ðŸ”‡</button>
              </div>`
            : "";

          // ðŸ–¼ Screenshot row
          const screenshotRow = screenshots.length
            ? `
              <div class="screenshot-row">
                ${screenshots
                  .map((s) => `<img src="${s.image}" alt="Screenshot" loading="lazy" class="screenshot-thumb" />`)
                  .join("")}
              </div>`
            : "";

          const content = `
            <div class="hero-banner" style="background-image:url('${img}')">
              <div class="overlay-gradient"></div>
              <div class="hero-content">
                <h1>${name}</h1>
                <div>Released: ${released}</div>
              </div>
            </div>
            ${trailer}
            ${screenshotRow}
            <div class="panel"><h2>About</h2><p>${description}</p></div>`;

          contentEl.innerHTML = content;
          statusEl.remove();
          contentEl.style.display = "block";

          // ðŸŽ§ Sound toggle
          const video = document.getElementById("gameTrailer");
          const btn = document.getElementById("soundToggle");
          if (video && btn) {
            btn.addEventListener("click", () => {
              video.muted = !video.muted;
              btn.textContent = video.muted ? "ðŸ”‡" : "ðŸ”Š";
            });
          }

          // ðŸŽ  Auto-scroll screenshots
          const row = document.querySelector(".screenshot-row");
          if (row) {
            let scrollSpeed = 0.7;
            function autoScroll() {
              if (row.scrollLeft + row.clientWidth >= row.scrollWidth) row.scrollLeft = 0;
              else row.scrollLeft += scrollSpeed;
              requestAnimationFrame(autoScroll);
            }
            autoScroll();
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error loading game data.";
        }
      }
      loadGame();
    </script>
  </body>
</html>
