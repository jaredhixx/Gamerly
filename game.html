<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gamerly â€“ Game</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #f9fafb;
        color: #111;
      }

      header {
        background: #111827;
        color: white;
        padding: 24px;
      }

      main {
        max-width: 900px;
        margin: 0 auto;
        padding: 24px;
      }

      a {
        color: #2563eb;
        text-decoration: none;
        font-weight: 600;
      }

      a:hover {
        text-decoration: underline;
      }

      .hero {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .imgWrap {
        width: 100%;
        height: 280px;
        background: #e5e7eb;
        border-radius: 14px;
        overflow: hidden;
      }

      .imgWrap img {
        width: 100%;
        height: 280px;
        object-fit: cover;
        display: block;
      }

      .title {
        font-size: 1.8rem;
        margin: 0;
        font-weight: 900;
        line-height: 1.15;
      }

      .meta {
        color: #6b7280;
        margin-top: 6px;
      }

      .panel {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
      }

      .badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }

      .badge {
        font-size: 0.75rem;
        color: #374151;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        padding: 3px 8px;
        border-radius: 999px;
      }

      .desc {
        white-space: pre-wrap;
        line-height: 1.5;
        color: #111;
      }
    </style>
  </head>

  <body>
    <header>
      <div style="max-width: 900px; margin: 0 auto;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <a href="/" style="color: white; text-decoration: none; font-weight: 900;">Gamerly ðŸ”¥</a>
          <span style="opacity: 0.6;">/</span>
          <a href="/" style="color: white; opacity: 0.9; text-decoration: none;">â¬… Back to New Releases</a>
        </div>
      </div>
    </header>

    <main>
      <div id="status" class="panel">Loadingâ€¦</div>
      <div id="content" style="display: none;"></div>
    </main>

    <script>
async function loadGame() {
  const slug = new URLSearchParams(window.location.search).get("slug");
  if (!slug) {
    document.getElementById("status").textContent = "Missing slug in URL.";
    return;
  }

  const res = await fetch(`/api/game?slug=${encodeURIComponent(slug)}&languages=en`, { cache: "no-store" });
  const data = await res.json();

  if (!res.ok) {
    document.getElementById("status").textContent = "Error loading game.";
    return;
  }

  const name = data?.name || "Untitled";
  const released = data?.released || "TBA";
  const img = data?.background_image || "";
  const website = data?.website || "";
  const description = data?.description_raw || "No description available.";
  const clip = data?.clip?.clip || null;
  const stores = Array.isArray(data?.stores) ? data.stores : [];

  const platforms = Array.isArray(data?.platforms)
    ? data.platforms.map(p => p?.platform?.name).filter(Boolean).slice(0, 10)
    : [];
  const genres = Array.isArray(data?.genres)
    ? data.genres.map(g => g?.name).filter(Boolean).slice(0, 10)
    : [];

  const badges = [...platforms, ...genres]
    .slice(0, 16)
    .map(x => `<span class="badge">${x}</span>`)
    .join("");

  let metacritic = data?.metacritic ?? null;
  if (!metacritic && Array.isArray(data.metacritic_platforms)) {
    const allScores = data.metacritic_platforms
      .map(p => p.metascore)
      .filter(s => typeof s === "number");
    if (allScores.length)
      metacritic = Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length);
  }

  const metaColor =
    metacritic >= 75 ? "#16a34a" : metacritic >= 50 ? "#facc15" : "#dc2626";

  const storeLinks = stores
    .map(
      (s) => `
      <a href="${s.url}" target="_blank" rel="noopener noreferrer" class="store-btn">
        Buy on ${s.store?.name || "Store"}
      </a>`
    )
    .join("");

  const trailer = clip
    ? `<video controls poster="${img}" class="trailer"><source src="${clip}" type="video/mp4" /></video>`
    : "";

  const content = `
    <div class="hero-banner" style="background-image:url('${img}')">
      <div class="overlay-gradient"></div>
      <div class="hero-content">
        <h1>${name}</h1>
        <div class="meta">Released: ${released}</div>
        <div class="score" style="background:${metaColor}">
          ${metacritic ? `Metacritic: ${metacritic}` : "No Score"}
        </div>
        <div class="badges">${badges}</div>
        <div class="links">
          ${website ? `<a href="${website}" target="_blank" class="store-btn">Official Site</a>` : ""}
          ${storeLinks}
        </div>
      </div>
    </div>

    ${trailer}

    <div class="panel">
      <h2>About</h2>
      <p>${description}</p>
    </div>
  `;

  document.getElementById("content").innerHTML = content;
  document.getElementById("status").remove();
}

loadGame();
</script>

  </body>
</html>
